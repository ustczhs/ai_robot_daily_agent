{% extends "layout.html" %}

{% block title %}{{ report_date }} 报告 - AI与机器人技术日报{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>
                    {{ report_date }} 技术日报详情
                </h4>
            </div>
            <div class="card-body">
                {% if content %}
                    <div class="report-content">
                        {{ content|safe }}
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        报告内容加载失败。
                    </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <small class="text-muted">
                            <i class="fas fa-tag me-1"></i>文件名: <code>{{ filename }}</code> |
                            <i class="fas fa-calendar me-1"></i>报告日期: {{ report_date }}
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="/reports" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>返回列表
                        </a>
                        <a href="/" class="btn btn-outline-primary btn-sm ms-2">
                            <i class="fas fa-home me-1"></i>最新报告
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 报告导航 -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-compass me-2"></i>报告导航
                </h5>
            </div>
            <div class="card-body">
                <nav aria-label="报告章节导航">
                    <ul class="nav nav-pills flex-column flex-sm-row" id="report-nav">
                        <!-- 导航将在JavaScript中生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 生成报告导航
document.addEventListener('DOMContentLoaded', function() {
    const navContainer = document.getElementById('report-nav');
    const headers = document.querySelectorAll('.report-content h2, .report-content h3');

    if (headers.length > 0) {
        headers.forEach((header, index) => {
            const level = header.tagName.toLowerCase();
            const text = header.textContent.trim();
            const id = 'nav-' + text.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');

            // 为标题添加ID
            header.id = id;

            // 创建导航项
            const li = document.createElement('li');
            li.className = 'nav-item me-2 mb-2';

            const a = document.createElement('a');
            a.className = `nav-link ${index === 0 ? 'active' : ''}`;
            a.href = '#' + id;
            a.textContent = text;

            // 根据标题级别调整样式
            if (level === 'h3') {
                a.classList.add('btn-sm');
                a.style.fontSize = '0.9em';
            }

            // 添加图标
            const icon = document.createElement('i');
            if (text.includes('概览')) {
                icon.className = 'fas fa-chart-bar me-1';
            } else if (text.includes('分类')) {
                icon.className = 'fas fa-tags me-1';
            } else if (text.includes('趋势')) {
                icon.className = 'fas fa-chart-line me-1';
            } else if (text.includes('洞察')) {
                icon.className = 'fas fa-lightbulb me-1';
            } else if (text.includes('预测')) {
                icon.className = 'fas fa-crystal-ball me-1';
            }

            a.insertBefore(icon, a.firstChild);
            li.appendChild(a);
            navContainer.appendChild(li);
        });

        // 添加导航点击事件
        document.querySelectorAll('#report-nav a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();

                // 更新活动状态
                document.querySelectorAll('#report-nav a').forEach(a => a.classList.remove('active'));
                this.classList.add('active');

                // 滚动到目标位置
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // 监听滚动，更新活动导航项
        window.addEventListener('scroll', function() {
            const scrollPosition = window.scrollY + 100;

            document.querySelectorAll('.report-content h2, .report-content h3').forEach(header => {
                const headerTop = header.offsetTop;
                const headerBottom = headerTop + header.offsetHeight;

                if (scrollPosition >= headerTop && scrollPosition < headerBottom) {
                    const targetId = header.id;
                    document.querySelectorAll('#report-nav a').forEach(a => {
                        a.classList.remove('active');
                        if (a.getAttribute('href') === '#' + targetId) {
                            a.classList.add('active');
                        }
                    });
                }
            });
        });
    } else {
        // 如果没有找到标题，显示提示信息
        navContainer.innerHTML = '<li class="nav-item"><span class="nav-link text-muted">暂无导航章节</span></li>';
    }
});
</script>
{% endblock %}
